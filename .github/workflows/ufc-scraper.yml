name: UFC Scraper

  on:
    schedule:
      - cron: '0 17 * * *'
    workflow_dispatch:

  jobs:
    scrape-ufc:
      runs-on: ubuntu-latest
      timeout-minutes: 30

      steps:
        - uses: actions/checkout@v4

        - uses: actions/setup-node@v4
          with:
            node-version: '20'

        - uses: pnpm/action-setup@v2
          with:
            version: 8

        - name: Install & Build
          run: |
            cd packages/backend
            pnpm install
            npx prisma generate
            pnpm build

        - name: Install Chromium
          run: cd packages/backend && npx puppeteer browsers install chrome

        - name: Run UFC Scraper
          env:
            DATABASE_URL: ${{ secrets.DATABASE_URL }}
            R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
            R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
            R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
            R2_BUCKET: ${{ secrets.R2_BUCKET }}
            R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
            SCRAPER_MODE: automated
          run: |
            cd packages/backend
            node dist/services/scrapeAllUFCData.js
            node -e "require('./dist/services/ufcDataParser.js').importUFCData().then(() => process.exit(0))"
